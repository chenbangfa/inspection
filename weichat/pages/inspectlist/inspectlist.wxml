<nav-bar navbar-data='{{navbarData}}'></nav-bar>

<!-- Top Header Bar -->
<view class="header-bar" style="top:{{height}}px;">
  <view class="team-selector" bindtap="showteamlist">
    <text class="current-team">{{tName || '选择团队'}}</text>
    <view class="triangle-down"></view>
  </view>
  <view class="header-actions">
    <view class="action-btn {{isBatchMode ? 'active-batch' : ''}}" bindtap="toggleBatchMode">
      <text>{{isBatchMode ? '取消批量' : '批量管理'}}</text>
    </view>
    <view class="action-btn filter-btn" bindtap="openFilterDrawer">
      <text>筛选</text>
      <view class="filter-icon"></view>
    </view>
  </view>
</view>

<!-- Active Filter Chips -->
<view class="filter-chips-container" style="top:{{height + 50}}px;" wx:if="{{sdate!='' || together!='' || zysearch!='' || zgState!=''}}">
  <scroll-view scroll-x="true" class="chips-scroll">
    <view class="chip" wx:if="{{sdate!=''}}">
      <text>日期范围</text>
      <view class="chip-close" bindtap="closedate">×</view>
    </view>
    <view class="chip" wx:if="{{together!=''}}">
      <text>人员: {{together}}</text>
      <view class="chip-close" bindtap="closehy">×</view>
    </view>
    <view class="chip" wx:if="{{zysearch!=''}}">
      <text>隐患: {{zysearch}}</text>
      <view class="chip-close" bindtap="closezy">×</view>
    </view>
    <view class="chip" wx:if="{{zgState!=''}}">
      <text>状态: {{zgStateName}}</text>
      <view class="chip-close" bindtap="closeZgState">×</view>
    </view>
  </scroll-view>
</view>

<!-- Main List Area -->
<view class="list-container" style="margin-top:{{height + 50 + (sdate!='' || together!='' || zysearch!='' || zgState!='' ? 40 : 0)}}px;">
  <checkbox-group bindchange="checkboxChange">
    <view wx:for="{{odlist}}" wx:for-item="articles" wx:key="id" wx:for-index="id" class="page-group">
      <view wx:for="{{articles}}" wx:for-item="item" wx:key="id" wx:for-index="index" class="articles">
        <checkbox wx:if="{{isBatchMode}}" value="{{item.id}}" checked="{{allSelected}}" class="batch-checkbox"></checkbox>
        
        <navigator url="../inspectinfo/inspectinfo?id={{item.id}}" class="item-navigator">
          <view class="vpic">
            <image src='https://xj.tajian.cc/{{item.hypic}}' class="pic" mode="aspectFill"></image>
          </view> 
          <view class="vcontent">
            <view class="vtit">
              <view class="tit">{{item.gsName}}</view>
              <span class="vspan">{{item.hyName}}</span>
            </view>    
            <view class="vinfo">
              <view class="vlist">{{item.yhContent}}</view>
            </view> 
            <view class="vinfo">
              <view class="vlist">{{item.addTime}}</view>
            </view>   
            <view class="vinfo">
              <image src='../../image/wz.png' class="addpic"></image>
              <view class="vlist">{{item.posAdd}}</view>
            </view>
            <view class="vinfo status-row">
               <text class="status-tag status-{{item.zgState}}" wx:if="{{item.zgState==0}}">待整改</text>
               <text class="status-tag status-{{item.zgState}}" wx:if="{{item.zgState==1}}">整改中: {{item.zgName}}</text>
               <text class="status-tag status-{{item.zgState}}" wx:if="{{item.zgState==2}}">已整改: {{item.zgName}}</text>
            </view>
          </view>
          <span class="arrow"></span>
        </navigator>
      </view>
    </view>
  </checkbox-group>

  <view class="vnodata" wx:if="{{isdata}}">
    <view>没有巡检记录~</view>
  </view>
</view>

<!-- Filter Drawer -->
<view class="drawer-mask" wx:if="{{showDrawer}}" bindtap="closeFilterDrawer"></view>
<view class="drawer {{showDrawer ? 'drawer-open' : ''}}" style="top:0; height: 100%;">
  <view class="drawer-content">
    <view class="drawer-header">筛选条件</view>
    
    <scroll-view scroll-y="true" style="height: calc(100% - 100px);">
      <!-- Date Filter -->
      <view class="filter-section">
        <view class="filter-title">日期范围</view>
        <view class="filter-tags">
          <view class="tag {{dateLimit=='today' ? 'active' : ''}}" bindtap="selectDateLimit" data-type="today">今日</view>
          <view class="tag {{dateLimit=='week' ? 'active' : ''}}" bindtap="selectDateLimit" data-type="week">本周</view>
          <view class="tag {{dateLimit=='month' ? 'active' : ''}}" bindtap="selectDateLimit" data-type="month">本月</view>
        </view>
        <view class="date-picker-row">
          <picker mode="date" value="{{tempSdate}}" bindchange="bindTempDateChange" data-type="start">
            <view class="date-input">{{tempSdate || '开始日期'}}</view>
          </picker>
          <text>-</text>
          <picker mode="date" value="{{tempEdate}}" bindchange="bindTempDateChange" data-type="end">
            <view class="date-input">{{tempEdate || '结束日期'}}</view>
          </picker>
        </view>
      </view>

      <!-- Status Filter -->
      <view class="filter-section">
        <view class="filter-title">整改状态</view>
        <view class="filter-tags">
          <view class="tag {{tempZgIndex==0 ? 'active' : ''}}" bindtap="selectTempZgState" data-index="0">全部</view>
          <view class="tag {{tempZgIndex==1 ? 'active' : ''}}" bindtap="selectTempZgState" data-index="1">待整改</view>
          <view class="tag {{tempZgIndex==2 ? 'active' : ''}}" bindtap="selectTempZgState" data-index="2">整改中</view>
          <view class="tag {{tempZgIndex==3 ? 'active' : ''}}" bindtap="selectTempZgState" data-index="3">已整改</view>
        </view>
      </view>

      <!-- Hazard Type Filter -->
      <view class="filter-section">
        <view class="filter-title">隐患分类</view>
        <view class="filter-tags">
          <view wx:for="{{zylist}}" wx:key="index" class="tag {{item.checked ? 'active' : ''}}" bindtap="toggleTempZy" data-index="{{index}}">
            {{item.gName}}
          </view>
        </view>
      </view>

      <!-- Personnel Filter -->
      <view class="filter-section">
        <view class="filter-title">巡检人员</view>
        <view class="filter-tags">
          <view wx:for="{{people}}" wx:key="index" class="tag {{item.checked ? 'active' : ''}}" bindtap="toggleTempPeople" data-index="{{index}}">
            {{item.hyName}}
          </view>
        </view>
      </view>
    </scroll-view>

    <view class="drawer-footer">
      <button class="reset-btn" bindtap="resetFilters">重置</button>
      <button class="confirm-btn" bindtap="applyFilters">确认</button>
    </view>
  </view>
</view>


<!-- Bottom Bar -->
<view wx:if="{{!isBatchMode}}" class="bottom-bar">
  <view class="count-text">合计：{{count}} 条</view>
  <view class="export-btn" bindtap="download">导出Excel</view>
</view>

<view wx:if="{{isBatchMode}}" class="bottom-bar batch-bar">
  <button size="mini" class="batch-action-btn" bindtap="selectAll">{{allSelected ? '取消全选' : '全选'}}</button>
  <button size="mini" type="primary" class="batch-action-btn primary" bindtap="showAssignModal">分配整改 ({{selectedItems.length}})</button>
</view>


<!-- Team Switcher Modal (Reused) -->
<view class="commodity_screen" wx:if="{{teamshow}}" bindtap="hideteam"></view>
<view class="commodity_attr_box" wx:if="{{teamshow}}" style="bottom:0;">
  <view class="modal-header">
    <text>切换团队</text>
    <view class="close-icon" bindtap="hideteam">×</view>
  </view>
  <scroll-view scroll-y="true" style="max-height: 300px;">
    <radio-group bindchange="teamchange">
      <label wx:for="{{teamlist}}" wx:key="index" class="team-item">
         <radio value="{{item.tId}}" checked="{{item.tId == tid}}"/>
         <text>{{item.tName}}</text>
      </label>
    </radio-group>
  </scroll-view>
</view>

<!-- Assignment Modal (Reused) -->
<view class="commodity_screen" wx:if="{{assignShow}}"></view>
<view class="commodity_attr_box assignment-modal" wx:if="{{assignShow}}">
    <view class="modal-title">分配整改任务</view>
    
    <view class="form-item">
        <picker range="{{people}}" range-key="hyName" bindchange="bindAssignUserChange">
             <view class="picker-input">
                指定整改人：<text class="highlight">{{assignUserIndex > -1 ? people[assignUserIndex].hyName : '请选择'}}</text>
             </view>
        </picker>
    </view>
    
    <view class="form-item">
        <textarea placeholder="请输入整改要求" bindinput="inputAssignRequest" class="textarea-input"/>
    </view>
    
    <view class="form-item">
        <picker mode="date" bindchange="bindAssignDateChange">
             <view class="picker-input">
                整改期限：<text>{{assignDeadline || '请选择'}}</text>
             </view>
        </picker>
    </view>
    
    <view class="modal-footer">
        <button bindtap="hideAssignModal" class="cancel-btn">取消</button>
        <button type="primary" bindtap="submitAssignment" class="confirm-btn">确认分配</button>
    </view>
</view>

